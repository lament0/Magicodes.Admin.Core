(function(){$(function(){var h=abp.services.app.hostDashboard,n=$("#HostDashboard"),u=n.find(".dashboard-report-range"),p=n.find("input[name='IncomeStatisticsDatePeriod']"),c=n.find(".expiring-tenants-table"),l=n.find(".recent-tenants-table"),w=n.find(".see-all-expiring-tenants"),b=n.find(".see-all-recent-tenants"),i=n.find(".income-statistics .income-statistics-chart"),k=n.find(".edition-statistics .caption-helper"),a=n.find(".edition-statistics .edition-statistics-chart"),d=n.find(".income-statistics .caption-helper"),g=n.find(".new-tenants-statistics .progress-info .status .status-title"),nt=n.find(".new-tenants-statistics .new-tenants-count"),tt=n.find(".new-subscription-statistics .progress-info .status .status-title"),it=n.find(".new-subscription-statistics .new-subscription-amount"),rt=n.find(".dashboard-statistics1 .dashboard-placeholder1"),ut=n.find(".dashboard-statistics2 .dashboard-placeholder2"),ft=n.find(".expiring-tenants .caption-helper"),et=n.find(".recent-tenants .caption-helper"),ot=n.find("button[name='RefreshButton']"),st=n.find(".counterup"),f=[],e=[],ht=[],ct="$",lt=n.find(".dashboard-report-range .selected-date-text").data("initial-report-day-count"),at={daily:1,weekly:2,monthly:3},t={startDate:moment().subtract(lt,"day").startOf("day"),endDate:moment().endOf("day")},vt=function(){u.attr("data-display-range")!=="0"&&u.html(t.startDate.format("LL")+" - "+t.endDate.format("LL"))},yt=function(n,t,i,r,u){ft.text(app.localize("ExpiringTenantsHelpText",t,i));f=n;c.jtable("load",{});w.data("subscriptionEndDateStart",r).data("subscriptionEndDateEnd",u).click(function(){window.open(abp.appPath+"Admin/Tenants?subscriptionEndDateStart="+encodeURIComponent($(this).data("subscriptionEndDateStart"))+"&subscriptionEndDateEnd="+encodeURIComponent($(this).data("subscriptionEndDateEnd")))})},pt=function(n,t,i,r){et.text(app.localize("RecentTenantsHelpText",t,i));e=n;l.jtable("load",{});b.data("creationDateStart",r).click(function(){window.open(abp.appPath+"Admin/Tenants?creationDateStart="+encodeURIComponent($(this).data("creationDateStart")))})},r=function(){return t.startDate.format("L")+" - "+t.endDate.format("L")},v=function(){return $("<div/>").addClass("note").addClass("note-info").addClass("text-center").append($("<small/>").addClass("text-muted").text("- "+app.localize("NoData")+" -"))},o=function(){return parseInt(p.closest(":checked").val())},y=function(n){var s=null,u,f,e,h,c;for(d.text(r()),u=[],f=0;f<n.length;f++)e=new Array(2),e[0]=moment(n[f].date).utc().valueOf(),e[1]=n[f].amount,u.push(e);if(ht=u,!n||n.length===0){i.html(v());return}$.plot(i,[{data:u,lines:{fill:.2,lineWidth:1},color:["#BAD9F5"]},{data:u,points:{show:!0,fill:!0,radius:4,fillColor:"#9ACAE6",lineWidth:2},color:"#9ACAE6",shadowSize:1},{data:u,lines:{show:!0,fill:!1,lineWidth:3},color:"#9ACAE6",shadowSize:0}],{xaxis:{mode:"time",timeformat:app.localize("ChartDateFormat"),minTickSize:[1,"day"],font:{lineHeight:20,style:"normal",variant:"small-caps",color:"#6F7B8A",size:10}},yaxis:{ticks:5,tickDecimals:0,tickColor:"#eee",font:{lineHeight:14,style:"normal",variant:"small-caps",color:"#6F7B8A"}},grid:{hoverable:!0,clickable:!1,tickColor:"#eee",borderColor:"#eee",borderWidth:1,margin:{bottom:20}}});h=function(){var n=$("#chartTooltip");n.length!==0&&n.remove()};c=function(n,t,i,r){h();$("<div id='chartTooltip' class='chart-tooltip'>"+i+"<br/>"+r+"<\/div >").css({position:"absolute",display:"none",top:t-60,left:n-40,border:"0",padding:"2px 6px",opacity:"0.9"}).appendTo("body").fadeIn(200)};i.bind("plothover",function(n,i,r){var f,e,h;if(r&&s!==r.dataIndex){var l=o(),u="",a=t.startDate.format("L")===t.endDate.format("L");l===at.daily||a?u=moment(r.datapoint[0]).format("dddd, DD MMMM YYYY"):(f=r.dataIndex===r.series.data.length-1,u+=moment(r.datapoint[0]).format("LL"),f?u+=" - "+t.endDate.format("LL"):(e=r.series.data[r.dataIndex+1],u+=" - "+moment(e[0]).format("LL")));s=r.dataIndex;h=app.localize("IncomeWithAmount","<strong>"+r.datapoint[1]+ct+"<\/strong>");c(r.pageX,r.pageY,u,h)}});i.bind("mouseleave",function(){s=null;h()})},wt=function(n){var i,u,t,f;if(!n||n.length===0){a.html(v());return}for(i=["#81A17E","#BA9B7C","#569BC6","#e08283","#888888"],u=[],t=0;t<n.length;t++)f={label:n[t].label,data:n[t].value},i[t]&&(f.color=i[t]),u.push(f);$.plot(a,u,{series:{pie:{show:!0,innerRadius:.3,radius:1,label:{show:!0,radius:1,formatter:function(n,t){return"<div class='pie-chart-label'>"+n+" : "+Math.round(t.percent)+"%<\/div>"},background:{opacity:.8}}}},legend:{show:!1},grid:{hoverable:!0,clickable:!0}});k.text(r())},bt=function(n){g.text(r());nt.text(n)},kt=function(n){tt.text(r());it.text(n)},dt=function(n){rt.text(n)},gt=function(n){ut.text(n)},ni=function(){st.counterUp()},ti=function(){abp.ui.setBusy(n);h.getDashboardStatisticsData({startDate:t.startDate.format("YYYY-MM-DDT00:00:00Z"),endDate:t.endDate.format("YYYY-MM-DDT23:59:59.999Z"),incomeStatisticsDateInterval:o()}).done(function(n){bt(n.newTenantsCount);kt(n.newSubscriptionAmount);dt(n.dashboardPlaceholder1);gt(n.dashboardPlaceholder2);ni();y(n.incomeStatistics);wt(n.editionStatistics);yt(n.expiringTenants,n.subscriptionEndAlertDayCount,n.maxExpiringTenantsShownCount,n.subscriptionEndDateStart,n.subscriptionEndDateEnd);pt(n.recentTenants,n.recentTenantsDayCount,n.maxRecentTenantsShownCount,n.tenantCreationStartDate)}).always(function(){abp.ui.clearBusy(n)})},s=function(){vt();ti()},ii=function(){abp.ui.setBusy(i);h.getIncomeStatistics({startDate:t.startDate.format("YYYY-MM-DDT00:00:00Z"),endDate:t.endDate.format("YYYY-MM-DDT23:59:59.999Z"),incomeStatisticsDateInterval:o()}).done(function(n){y(n.incomeStatistics)}).always(function(){abp.ui.clearBusy(i)})},ri=function(){n.find("input[name='IncomeStatisticsDatePeriod']").change(function(){this.checked&&ii()})},ui=function(){c.jtable({paging:!1,sorting:!1,multiSorting:!1,actions:{listAction:{method:function(){return $.Deferred(function(n){n.resolve({items:f,totalCount:f.length})})}}},fields:{tenantName:{title:app.localize("TenantName")},remainingDayCount:{title:app.localize("RemainingDay")}}})},fi=function(){l.jtable({paging:!1,sorting:!1,multiSorting:!1,actions:{listAction:{method:function(){return $.Deferred(function(n){n.resolve({items:e,totalCount:e.length})})}}},fields:{name:{title:app.localize("TenantName")},creationTime:{title:app.localize("CreationTime"),display:function(n){return moment(n.record.creationTime).format("L LT")}}}})},ei=function(){ri();ui();fi();s()};u.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),t),function(n,i){t.startDate=n;t.endDate=i;s()});ot.click(function(){s()});ei()})})();