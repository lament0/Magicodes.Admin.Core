(function(){$(function(){function i(n){n?o.jtable("reload"):o.jtable("load",v())}function g(n){abp.message.confirm(app.localize("TenantDeleteWarningMessage",n.tenancyName),function(t){t&&e.deleteTenant({id:n.id}).done(function(){i();abp.notify.success(app.localize("SuccessfullyDeleted"))})})}var e=abp.services.app.tenant,o=$("#TenantsTable"),a=$("#TenantsTableFilter"),f=$("#TenantsFormFilter"),s=$("#TenantsTable_SubscriptionEndDateRangeActive"),h=f.find("input[name='SubscriptionEndDateRange']"),c=$("#TenantsTable_CreationDateRangeActive"),l=f.find("input[name='CreationDateRange']"),y=f.find("button[name='RefreshButton']"),p=f.find("#EditionDropdown"),t={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),"delete":abp.auth.hasPermission("Pages.Tenants.Delete")},n={creationDateStart:$.url().param("creationDateStart"),creationDateEnd:$.url().param("creationDateEnd"),subscriptionEndDateStart:$.url().param("subscriptionEndDateStart"),subscriptionEndDateEnd:$.url().param("subscriptionEndDateEnd")},r={startDate:n.subscriptionEndDateStart?moment(n.subscriptionEndDateStart):moment().startOf("day"),endDate:n.subscriptionEndDateEnd?moment(n.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},u={startDate:n.creationDateStart?moment(n.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:n.creationDateEnd?moment(n.creationDateEnd):moment().endOf("day")},v;h.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),r),function(n,t){r.startDate=n;r.endDate=t});l.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),u),function(n,t){u.startDate=n;u.endDate=t});var w=new app.ModalManager({viewUrl:abp.appPath+"Admin/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/Admin/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),b=new app.ModalManager({viewUrl:abp.appPath+"Admin/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/Admin/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),k=new app.ModalManager({viewUrl:abp.appPath+"Admin/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/Admin/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),d=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers});o.jtable({title:app.localize("Tenants"),paging:!0,sorting:!0,multiSorting:!0,actions:{listAction:{method:e.getTenants}},fields:{id:{key:!0,list:!1},actions:{title:app.localize("Actions"),width:"14%",sorting:!1,type:"record-actions",cssClass:"btn btn-xs btn-primary blue",text:'<i class="fa fa-cog"><\/i> '+app.localize("Actions")+' <span class="caret"><\/span>',list:t.edit||t.delete,items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return t.impersonation},action:function(n){d.open({extraFilters:{tenantId:n.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:n.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(n.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return t.edit},action:function(n){b.open({id:n.record.id})}},{text:app.localize("Features"),visible:function(){return t.changeFeatures},action:function(n){k.open({id:n.record.id})}},{text:app.localize("Delete"),visible:function(){return t.delete},action:function(n){g(n.record)}},{text:app.localize("Unlock"),action:function(n){e.unlockTenantAdmin({id:n.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",n.record.name))})}}]},tenancyName:{title:app.localize("TenancyCodeName"),display:function(n){var t=$("<div> "+n.record.tenancyName+"<\/div>");return n.record.connectionString&&t.prepend($("<i class='fa fa-database' title=\""+app.localize("HasOwnDatabase")+'"><\/i>')),t},width:"16%"},name:{title:app.localize("Name"),width:"20%"},editionDisplayName:{title:app.localize("Edition"),width:"18%"},subscriptionEndDateUtc:{title:app.localize("SubscriptionEndDateUtc"),width:"15%",display:function(n){return n.record.subscriptionEndDateUtc?moment(n.record.subscriptionEndDateUtc).format("L"):""}},isActive:{title:app.localize("Active"),width:"8%",display:function(n){return n.record.isActive?'<span class="label label-success">'+app.localize("Yes")+"<\/span>":'<span class="label label-default">'+app.localize("No")+"<\/span>"}},creationTime:{title:app.localize("CreationTime"),width:"20%",display:function(n){return moment(n.record.creationTime).format("L")}}}});v=function(){var t=p.find(":selected").val(),n={filter:a.val(),editionId:t,editionIdSpecified:t!=="-1"};return c.prop("checked")&&(n.creationDateStart=u.startDate,n.creationDateEnd=u.endDate),s.prop("checked")&&(n.subscriptionEndDateStart=r.startDate,n.subscriptionEndDateEnd=r.endDate),n};$("#CreateNewTenantButton").click(function(){w.open()});$("#GetTenantsButton").click(function(n){n.preventDefault();i()});abp.event.on("app.editTenantModalSaved",function(){i(!0)});abp.event.on("app.createTenantModalSaved",function(){i(!0)});s.change(function(){h.prop("disabled",!$(this).prop("checked"))});n.subscriptionEndDateStart||n.subscriptionEndDateEnd?s.prop("checked",!0):h.prop("disabled",!0);c.change(function(){l.prop("disabled",!$(this).prop("checked"))});n.creationDateStart||n.creationDateEnd?c.prop("checked",!0):l.prop("disabled",!0);y.click(function(n){n.preventDefault();i()});a.focus();i()})})();